<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} Poet's Playlist</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="../static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <!-- CHANGE: javascript files are deleted -->
    <!-- <script src="static/script.js" async></script> 
    <script src="static/department.js" async></script> -->
</head>


<body>
    <header>
        <div class="parent">
            <div id="white-space"></div>
            <div id="header">
                <h1>Poet's Playlist</h1>
                <div id="logo">
                    <img id="bear" src="../static/images/logo.png" alt="logo" />
                </div>
            </div>
    </header>

    <div class="container">

        <!-- Add search button -->
        <div class="input-box" onclick="sendFocus()">
            <input type="text" placeholder="Enter poem titles (separated by semicolons)" id="filter-text-val" oninput="dropdownCode()">
            <button onclick="filterText()">Search</button>
        </div>


        <div class="dropdown-box">
            <select id="titleDropdown" size="10" style="display:none;" onclick="selectTitle()"></select>
        </div>
        
        <script>
            function dropdownCode() {
                document.getElementById('titleDropdown').innerHTML = ''; // Start with empty dropdown box

                const input = document.getElementById('filter-text-val').value.toLowerCase(); // get a lowercase version of the query
                
                const titles = [ // Placeholder --> Should be replaced with an actual list of titles (read in from elsewhere...?)
                    "Title 1",
                    "Title 2",
                    "Title 3"
                ];
                
                if (input.length > 0) {
                    titles.forEach(title => { // For each title in the list
                        if (title.toLowerCase().includes(input.toLowerCase())) { // If the title text contains the current query
                            const option = document.createElement('option');
                            option.value = title;
                            option.textContent = title;
                            document.getElementById('titleDropdown').appendChild(option); // Add that title to the list of options
                        }
                    });
                } else {
                    document.getElementById('titleDropdown').innerHTML = '';
                }

                if (document.getElementById('titleDropdown').options.length > 0) { // Hide the dropdown thingy if there's nothing inside
                    document.getElementById('titleDropdown').style.display = 'block';
                } else {
                    document.getElementById('titleDropdown').style.display = 'none';
                }
            }
        
            function filterText() {
                const selectedTitle = document.getElementById('titleDropdown').value;
                document.getElementById('filter-text-val').value = selectedTitle;
            }

            function selectTitle() {
                const selectedTitle = document.getElementById('titleDropdown').value;
                document.getElementById('filter-text-val').value = selectedTitle;
                document.getElementById('titleDropdown').innerHTML = '';
                document.getElementById('titleDropdown').style.display = 'none';
            }
        </script>
        <!-- <div class="search-box">
            <input type="text" id="searchBox" placeholder="Enter a poem title">
            <button onclick="search()">Search</button>
        </div> -->
        <div class="genres-container">
            <h2>Genres:</h2>
            <div class="genres">
                <label for="popCheckbox"><input type="checkbox" id="popCheckbox" value="pop"> Pop</label>
                <label for="rockCheckbox"><input type="checkbox" id="rockCheckbox" value="rock"> Rock</label>
                <label for="countryCheckbox"><input type="checkbox" id="countryCheckbox" value="country">
                    Country</label>
                <label for="jazzCheckbox"><input type="checkbox" id="jazzCheckbox" value="jazz"> Jazz</label>
                <label for="indieCheckbox"><input type="checkbox" id="indieCheckbox" value="indie"> Indie</label>
                <label for="alternativeCheckbox"><input type="checkbox" id="alternativeCheckbox" value="alternative">
                    Alternative</label>
                <label for="synthpopCheckbox"><input type="checkbox" id="synthpopCheckbox" value="synthpop">
                    Synth-pop</label>
                <label for="poprockCheckbox"><input type="checkbox" id="poprockCheckbox" value="poprock"> Pop
                    Rock</label>
                <label for="musicalsCheckbox"><input type="checkbox" id="musicalsCheckbox" value="musicals">
                    Musicals</label>
                <label for="acousticCheckbox"><input type="checkbox" id="acousticCheckbox" value="acoustic">
                    Acoustic</label>
            </div>
        </div>
        <div id = 'loading' style = 'display: none;'>
            <div class = "loader"></div>
        </div>
        <div id = "answer-box">
            
        </div>
        <!-- CHANGE: adding refresh and autocomplete-->
                <div id="refresh-instructions">
            <p>Please like or dislike the songs as you prefer, then click "Refresh" to see new recommendations based on
                your feedback.</p>
        </div>
        <button onclick="refreshResults()">Refresh Results</button>
        <p id="refresh-count">Refreshes left: 5</p>
    </div>

    </div>   <!-- CHANGE: end of change in html -->

    <script>

        //change in jscript
        
        $(function () {
            $("#filter-text-val").autocomplete({
                source: "/autocomplete",
                minLength: 2  // Minimum length of query to trigger autocomplete
            });
        });

        let refreshCount = 5;
        let feedback = {};

        function filterText() {
            document.getElementById('loading').style.display = 'block';
            console.log("Filtering Text");
            document.getElementById("answer-box").innerHTML = "";
            fetch("/episodes?" + new URLSearchParams({
                song_name: document.getElementById("filter-text-val").value,
                genre: search()
            }).toString())
                .then((response) => response.json())
                .then((data) => {
                    data.forEach(song => {
                        let tempDiv = document.createElement("div");
                        tempDiv.innerHTML = answerBoxTemplate(song.song_name, song.song_id, song.artist);
                        document.getElementById("answer-box").appendChild(tempDiv);
                    });
                });
            // document.getElementById('loading').style.display = 'none';
        }

        function answerBoxTemplate(song_name, song_id, song_artist) {
            document.getElementById('loading').style.display = 'none';
            return `<div class='song-player'>
                <h3 class='episode-title'>${song_name}</h3>
                <p class='episode-title'>${song_artist}</p>
                <button onclick="likeSong(${song_id})">Like</button>
                <button onclick="dislikeSong(${song_id})">Dislike</button>

            </div>`;
        }

        function likeSong(song_id) {
            feedback[song_id] = 1;
        }

        function dislikeSong(song_id) {
            feedback[song_id] = -1;
        }

        function refreshResults() {
            if (refreshCount > 0) {
                fetch("/update_recommendations", {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedback })
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("answer-box").innerHTML = "";
                        data.forEach(song => {
                            let tempDiv = document.createElement("div");
                            tempDiv.innerHTML = answerBoxTemplate(song.song_name, song.song_id);
                            document.getElementById("answer-box").appendChild(tempDiv);
                        });
                        refreshCount--;
                        document.getElementById("refresh-count").innerText = `Refreshes left: ${refreshCount}`;
                    });
            } else {
                alert("You have reached the maximum number of refreshes. Please start a new query.");
            }
        }

        //end of change
        
        function search() {
            // Retrieve search query from the search box
            // const searchQuery = document.getElementById('searchBox').value;

            // Retrieve selected genres from checkboxes
            const selectedGenres = [];
            const checkboxes = document.querySelectorAll('input[type=checkbox]:checked');
            checkboxes.forEach((checkbox) => {
                selectedGenres.push(checkbox.value);
            });

            // Perform search based on the search query and selected genres
            // You can implement your search logic here, such as making an AJAX request
            // console.log('Search Query:', searchQuery);
            console.log('Selected Genres:', selectedGenres);
            return selectedGenres;
        }

        // CHANGE: Added the deleted functions back (modified a bit)

        // function answerBoxTemplate(song_name){ // CHANGE: We want song_names instead of other features & Deleted unused features.
        //     return `<div class=''>
        //         <h3 class='episode-title'>${song_name}</h3> 
                
        //     </div>`
        // }

        function sendFocus(){
            document.getElementById('filter-text-val').focus()
        }

        // function filterText(){
        //     document.getElementById("answer-box").innerHTML = ""
        //     console.log(document.getElementById("filter-text-val").value)
        //     // CHANGE: Replaced URLSearchParams parameter to song_name 
        //     fetch("/episodes?" + new URLSearchParams({ song_name: document.getElementById("filter-text-val").value, genre: search() }).toString())
        //     .then((response) => response.json())
        //     .then((data) => data.forEach(row => {
                
        //         let tempDiv = document.createElement("div")
        //         tempDiv.innerHTML = answerBoxTemplate(row.song_name) // CHANGE: Replaced row
        //         document.getElementById("answer-box").appendChild(tempDiv)
        //     }));

        // }
    </script>
</body>

</html>
